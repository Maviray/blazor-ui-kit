name: Publish NuGet Packages

on:
  push:
    branches:
      - master
      - main
      - develop
      - 'feature/*alpha*'
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Force specific version (optional, e.g., 1.2.3)'
        required: false

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'
  PACKAGES_PATH: '${{ github.workspace }}/artifacts'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for GitVersion to calculate history

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.10.2
      with:
        versionSpec: '5.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0.10.2
      with:
        useConfigFile: true
        configFilePath: GitVersion.yml

    - name: Resolve Final Version
      id: version
      run: |
        # Default to calculated GitVersion
        CALCULATED_VERSION="${{ steps.gitversion.outputs.nuGetVersionV2 }}"
        BRANCH_NAME="${{ steps.gitversion.outputs.branchName }}"
        
        # Override if manual input provided
        if [ "${{ github.event.inputs.force_version }}" != "" ]; then
          FINAL_VERSION="${{ github.event.inputs.force_version }}"
          echo "‚ö†Ô∏è Using forced version: $FINAL_VERSION"
        else
          FINAL_VERSION="$CALCULATED_VERSION"
        fi

        echo "version=$FINAL_VERSION" >> $GITHUB_OUTPUT
        echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        
        echo "üì¶ Package Version: $FINAL_VERSION"
        echo "üåø Branch: $BRANCH_NAME"

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build -c ${{ env.CONFIGURATION }} --no-restore /p:Version=${{ steps.version.outputs.version }}

    - name: Run tests
      run: dotnet test -c ${{ env.CONFIGURATION }} --no-build --verbosity normal

    - name: Create packages directory
      run: mkdir -p ${{ env.PACKAGES_PATH }}

    - name: Pack NuGet packages
      run: |
        # Verify src directory exists
        if [ ! -d "src" ]; then
          echo "‚ö†Ô∏è Warning: src directory not found. Skipping package creation."
          exit 0
        fi
        
        # Find all csproj files in src recursively
        find src -name "*.csproj" | while read project; do
            echo "üì¶ Packing $project..."
            dotnet pack "$project" \
              -c ${{ env.CONFIGURATION }} \
              --no-build \
              --output ${{ env.PACKAGES_PATH }} \
              /p:PackageVersion=${{ steps.version.outputs.version }} \
              /p:Version=${{ steps.version.outputs.version }} \
              /p:RepositoryBranch="${{ steps.version.outputs.branch }}" \
              /p:RepositoryCommit=${{ github.sha }}
        done

    - name: Configure GitHub Packages source
      run: |
        dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
          --name "github" \
          --username "${{ github.actor }}" \
          --password "${{ secrets.GITHUB_TOKEN }}" \
          --store-password-in-clear-text

    - name: Publish to GitHub Packages
      run: |
        dotnet nuget push "${{ env.PACKAGES_PATH }}/*.nupkg" \
          --source "github" \
          --api-key ${{ secrets.GITHUB_TOKEN }} \
          --skip-duplicate   

    - name: Create GitHub Release
      if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && steps.gitversion.outputs.preReleaseTag == ''
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        generate_release_notes: true
        files: ${{ env.PACKAGES_PATH }}/*.nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
